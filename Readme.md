# IFURED: IDL GUI-based package for SCORPIO-2/IFU data reduction. 



****** Требования для корректной работы *******
1) Необходим пакет графических программ COYOTE (лежит в отдельной папке рядом с основными программами) - IDL должен их видеть
2) Требуется более-менее свежая версия astrolib. В частности, в старых версиях может не быть требуемых процедур, находящихся в свежих версиях в astrolib/robust
3) В программе IFURED_COMMON_DEF.pro прописать переменные ifu_dir, stand_dir, log_dir, в которых содержатся пути к пакету IFURED, dat-файлам с SED звезд-стандартов и логами обработки. Здесь же в переменной unzipper прописать команду (с путем до exe-файла, если нужно), используемую для разархивирования zip-файлов.
4) При желании - можно настроить размер главного окна, кнопок и тд в том же файле в переменной sz. 


****** Используемые вспомогательные файлы ******
1) Отождествление линий неона для разных решеток - все файлы типа VPHG1200@540.txt должны находится в папке IFURED/Grisms. Используется на этапе поиска геометрии и построения дисперсионной кривой. Формат файла: первая строка - комментарий, далее - значения начальной, конечной длины волны и дисперсии по умолчанию для данной решетки, после этого - координаты положения линий в пикселях, ангстремах и номер щели (0 - левая, 1 - правая)
2) Измеренные положения фиберов на щели master_pos.txt - используется на этапе поиска траекторий фиберов. Формат файла: в первой колонке номер фибера задается 4-значным числом (строка, столбец), эталонным фиберам соответствует 0 строка. Во 2 и 4 колонках указываются координаты для левой и правой щели.
3) lines.tab - файл со списком линий неона, их интенсивностей и длин волн. Скопирован из прошлых пакетов MPFS и long slit
4) Файлы со спектрофотометрическими стандартами, используются для определения DQE.

****** Форматы выходных файлов ******
_i.fts - начальные фреймы, представляющие собой сумму различных экспозиций с вычещенными следами космических частиц.
_warp.fts - файлы с исправленной геометрией
_s.fts - файлы с экстрагированными потоками для каждого фибера
_lin.fts - линеаризованные фреймы
_n.fts - кубы данных, деленные на flat
_cub.fts - кубы данных, не деленные на flat. Создаются только если ставится галочка "не делить на флэт"
-sky.fts - кубы данных с вычтенным небом
_abs.fts - калиброванные кубы данных
_corr.fts - кубы данных, скорректированные за атмосферную дисперсию

****** Описание последовательности выполнения основных процедур. ******

Запуск программы - @ifured
При этом выполняется скрипт ifured.pro - компилируются все необходимые процедуры.
Все, что непосредственно связано с работой пакета, лежит в корневой директории IFURED
В папке external находятся используемые внешние процедуры, продублированные здесь для того, чтоб избежать конфликта версий
Большая часть вспомогательных процедур (например, поиск пиков линии, парсер лог-файла, процедура для разархивирования файлов и тд) находится в ifured_auxiliary.pro

Шаги обработки:
1) Загрузка log-file => вызывается программа ifured_parse_log, которая считывает параметры из лог-файла. После этого проверяется наличие файла neon_i.fts. Если он есть - из его шапки берутся данные о решетке, а из файла Grisms/VPHG????.txt - данные о начальной, конечной длине волны и дисперсии.

2) Создание meanbias - происходит поиск всех фреймов bias с нужным биннингом. Происходит это в IFURED_CRE_BIAS. Перед этим идет проверка, существует ли директория с названием загруженного лог-файла. Если нет - она создается, в ней в дальнейшем идет вся обработка.

3) Складывание разных экспозиций для каждого типа данных + вычитание частиц. 
Сначала с помощью процедуры IFURED_CHECK_INI_FILES ведется поиск экспозиций разного типа внутри соответствующего куба. Затем вызываются процедуры IFURED_COMBINE, внутри которой - IFURED_ADDEXP. В последней происходят все дальнейшие действия с файлами - их обрезание, разбиение на 2 щели, складывание).
Считываются параметры из окошек OVERSCAN, LEFT SLIT END, RIGHT SLIT START. Если в overscan x1 или y1 = 0 - при обрезании файла используются значения nx-1 и ny-1. 
LEFT SLIT END, RIGHT SLIT START - координаты конца левой щели и начала правой на кадре.
Все экспозиции obj, neon, flat, sky, star сдвигаются по y к первой экспозиции obj, экспозиции eta сдвигаются к сдвинутому ранее flat.  Neon сдвигается также по X к первой экспозиции.
В конце считываются параметры решетки из файла neon_i.fts, после чего из файла Grisms/VPHG????.txt берутся данные о начальной, конечной длине волны и дисперсии.

4) Поиск траекторий в файле eta_i.fts. Вызывается процедура IFURED_TRAECTORY, считываются параметры STEP (шаг по x для узлов траектории) и WIN (ширина окна вдоль дисперсии при построения вектора вдоль оси y). В этой процедуре определяются необходимые параметры, которые не будут меняться - число эталонных и объектных фиберов. Алгоритм проходит вдоль оси дисперсии с шагом TRA_STEP, выделяет векторы вдоль оси кросс-дисперсии путем интегрирования с окном в TRA_WIN пикселей. В каждом векторе ищутся пики. Если их число не соответствует числу эталонных фиберов – этот вектор отбрасывается. Остается некоторое количество столбцов с числом элементов, равным числу эталонных фиберов. Положения этих элементов аппроксимируются полиномами второй степени (отдельно для правой и левой щели).
После того, как построены траектории эталонов, координаты каждого узла на них сравниваются с таковыми в файле MASTER_POS.txt. После этого в IFURED_PEAKS_FIBERS из заданных позиций всех фиберов в файле MASTER_POS.txt вычисляются их положения на flat и уточняются путем вписывания параболы.
На выходе создается файл traectory.fit с результатами аппроксимации траектории каждого фибера полиномом 2 порядка

5) Построение геометрии. Здесь для поиска линий неона исползуется файл с положениями линии для заданной решетки (Grisms/VPHG???.txt), файл lines.tab с описанием линий в спектре неона, ширины окна по X и Y считываются из интерфейса программы. Построение геометрии происходит в IFURED_GEOMETRY.pro, поиск линий неона - в подпрограмме IFURED_GEOMETRY_NEON_FIND в том же файле. После того, как найдены линии неона (аппроксимированные параболой), ищется их пересечение с траекториями всех фиберов. Координаты этих пересечений используются для входа в WARP_TRI на следующем шаге. Начальные и конечные координаты записываются в файл WARP.fit. Здесь же создается файл FIBER_POS.FIT, куда пишу координаты по y каждого фибера после исправления геометрии.

6) Коррекция геометрии - используя данные в файле WARP.fit - с помощью WARP_TRI преобразуем фреймы. Происходит это в IFURED_DO_WARP. На выходе - файлы с суффиксом "_warp.fts"

7) Экстракция спектров. В файле IFURED_TEST_WARP.pro идет проверка качества исправления геометрии - отдельно для каждого участка между соседними эталонными фиберами ищется остаточный наклон траектории. В идеале он равен 0 и этот этап ни на что не влияет. На выходе создается файл FIBERS_POS_GRAD.FIT, который аналогичен созданному ранее fiber_pos.fit, но здесь же для каждого фибера приведен угол наклона. 
Следующий шаг - собственно экстракция спектров, происходит с учетом определенного наклона в процедуре IFURED_CROSS_TALK_REM. Здесь же реализована возможность оптимальной экстракции, которую нужно доробатывать, которая довольно неплохо вписывает профили Фойгта во всю гребенку фиберов сразу, но не проработано дальнейшее определение потока в каждом фибере для каждого типа экспозиции.
На выходе - файлы с суффиксом "_с.fts"

8) Построение дисперсионной кривой - в файле IFURED_DISPERSION_CURVE.pro. Адаптированная версия программ для MPFS и длинной щели. Использует положения линий неона для заданной решетки (Grisms/VPHG???.txt) и файл lines.tab с описанием линий в спектре неона. Создает файл DISPER.FTS

9) Линеаризация - реализована в программе IFURED_LINERIS. Использует построенную дисперсионку, начальную и конечную длину волны + дисперсию из окошек в графическом интерфейсе. Эти параметры выставляются равными значениям по умолчанию для данной решетки на этапах загрузки лог-файла или создания начального файла (_i.fts). Если перед линеаризацией  параметры в окне изменить - будут использованы новые значения.
На выходе - файлы с суффиксом _lin.fts

10) Создание куба flat. Куб создается программой IFURED_CUB_EXTRACTION, а нормированный flat - IFURED_FLATNORM. Раскрутка фиберов происходит в подпрограмме IFURED_PACK_FIBERS.
В итоге создается файл flat_n.fts с распределением остаточных вариаций на flat, и нормированный flat_sens.fit, на который потом будут делиться остальные кубы.

11) Создание кубов остальных данных. Куб создается программой IFURED_CUB_EXTRACTION, раскрутка фиберов происходит в подпрограмме IFURED_PACK_FIBERS. После этого кубы делятся на flat_sens.fit в процедуре IFURED_FLATCUB_REDUCT. Создаются файлы с суффиксом _n.fts

12) Вычитание неба. Пока стоит SKIP_SKYSUB=1 - ничего не происходит, просто копируются файлы в новые с суффиксом _sky.fts. А вообще вычитание неба должно быть в IFURED_SKY_SUBTRACT

13) Считаем DQE в процедуре IFURED_CREA_SENT. Автоматически из шапки фрейма STAR берется информация об объекте, после чего ищется нужный для данной звезды файл в директории со стандартами. Если вдруг имя объекта в шапке записано криво - программа ничего не найдет. В таком случае нужно указать в лог-файле параметр ST_TABLE='путь к файлу со звездой'
Создается файл sent.fts

14) Калибровка по потоку - в процедуре IFURED_CORRSENT. Создаются файлы с суффиксом _abs.fts

15) Поправка за атмосферную дисперсию - в программах IFURED_ATM_DIS и IFURED_ATM_COR (копия из пакета MPFS). На выходе - файлы с суффиксом _cor.fts
